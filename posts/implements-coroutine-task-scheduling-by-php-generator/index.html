<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="fatrbaby"/>

  
  <meta name="description" content="本文是根据我在公司内部分享内容整理而来。很久没有写过博客了，为了讲清楚这个协程调度，我还是花了不少功夫，所以把它记录下来。
"/>
  

  
  
  <meta name="keywords" content="fatrbaby, 二链子和绕, 江湖夜雨十年灯, 龟, 爬宠, PHP, Java, golang"/>
  

  
  <link rel="canonical" href="http://xiaker.net/posts/implements-coroutine-task-scheduling-by-php-generator/"/>

  

  <title>PHP生成器实现协程任务调度 &middot; 江湖夜雨十年灯</title>

  <link rel="shortcut icon" href="http://xiaker.net/images/favicon.ico"/>
  <link rel="stylesheet" href="http://xiaker.net/css/animate.min.css"/>
  <link rel="stylesheet" href="http://xiaker.net/css/remixicon.css"/>
  <link rel="stylesheet" href="http://xiaker.net/css/zozo.css"/>
  <link rel="stylesheet" href="http://xiaker.net/css/highlight.css"/>

  
  
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">首页</a>
      </li>
      
      <li>
        <a href="/posts/">归档</a>
      </li>
      
      <li>
        <a href="/tags/">标签</a>
      </li>
      
      <li>
        <a href="/about/">关于</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="http://xiaker.net">
          <span>江湖夜雨十年灯</span>
          <img src="http://xiaker.net/images/logo.svg"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">仗剑江湖载酒行</p>
      <div class="my_socials">
        
        
        <a href="%20" title="facebook" target="_blank"><i class="remixicon-facebook-fill"></i></a>
        
        
        
        <a href="https://github.com/fatrbaby" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="%20" title="instagram" target="_blank"><i class="remixicon-instagram-fill"></i></a>
        
        
        
        <a href="%20" title="twitter" target="_blank"><i class="remixicon-twitter-fill"></i></a>
        
        
        
        <a href="https://weibo.com/fatrbaby" title="weibo" target="_blank"><i class="remixicon-weibo-fill"></i></a>
        
        
        <a href="http://xiaker.net/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='/posts/implements-coroutine-task-scheduling-by-php-generator/'>PHP生成器实现协程任务调度</a></h2>
          <span class="date">2020.11.17</span>
        </div>
        <div class="post_content markdown"><p>本文是根据我在公司内部分享内容整理而来。很久没有写过博客了，为了讲清楚这个协程调度，我还是花了不少功夫，所以把它记录下来。</p>
<h2 id="从一道面试题说起">从一道面试题说起</h2>
<p><strong>现在有一台内存为1G的服务器，和一个大小为5G的日志文件。请你写一个方法，逐行返回这个日志的内容，以供其他程序分析日志内容。</strong></p>
<blockquote>
<p>这个面试题可个比较鸡贼的地方是『逐行返回日志内容』，而不能直接『逐行处理日志内容』。我们应该如何回答？</p>
</blockquote>
<h2 id="生成器的应用场景">生成器的应用场景</h2>
<h3 id="示例1range">示例1：range</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$start <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory_get_usage</span>();
$array1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10000000</span>);

<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Memory use:&#39;</span>, <span style="color:#a6e22e">memory_get_usage</span>() <span style="color:#f92672">-</span> $start, <span style="color:#e6db74">&#39; bytes&#39;</span>, <span style="color:#a6e22e">PHP_EOL</span>;
</code></pre></div><h3 id="示例2迭代器">示例2：迭代器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Arrays</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">Iterator</span>
{
    <span style="color:#66d9ef">protected</span> $from;
    <span style="color:#66d9ef">protected</span> $to;
    <span style="color:#66d9ef">protected</span> $current;
    <span style="color:#66d9ef">protected</span> $key;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($from, $to)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span> <span style="color:#f92672">=</span> $from;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">to</span> <span style="color:#f92672">=</span> $to;

        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">current</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">next</span>()
    {
        <span style="color:#f92672">++</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span>;
        <span style="color:#f92672">++</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">key</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">valid</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span> <span style="color:#f92672">&gt;=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span> <span style="color:#f92672">&amp;&amp;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span> <span style="color:#f92672">&lt;=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">to</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">rewind</span>()
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">from</span>;
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$start <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory_get_usage</span>();

<span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Arrays</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10000000</span>) <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $value) {
}

<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Memory use:&#39;</span>, <span style="color:#a6e22e">memory_get_usage</span>() <span style="color:#f92672">-</span> $start, <span style="color:#e6db74">&#39; bytes&#39;</span>, <span style="color:#a6e22e">PHP_EOL</span>;
</code></pre></div><h3 id="示例3yield">示例3：yield</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">generator</span>($from, $to, $step <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
{
    <span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> $from; $i <span style="color:#f92672">&lt;=</span> $to; $i <span style="color:#f92672">+=</span> $step) {
        <span style="color:#66d9ef">yield</span> $i;
    }
}

$start <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory_get_usage</span>();

<span style="color:#66d9ef">foreach</span> (<span style="color:#a6e22e">generator</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10000000</span>) <span style="color:#66d9ef">as</span> $value) {
    <span style="color:#75715e">// echo $value, PHP_EOL;
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;Memory use:&#39;</span>, <span style="color:#a6e22e">memory_get_usage</span>() <span style="color:#f92672">-</span> $start, <span style="color:#e6db74">&#39; bytes&#39;</span>, <span style="color:#a6e22e">PHP_EOL</span>;
</code></pre></div><h3 id="生成器本体">生成器本体</h3>
<blockquote>
<p><strong>Since PHP 5.5, <a href="https://wiki.php.net/rfc/generators">https://wiki.php.net/rfc/generators</a></strong></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e"># var_dump()
</span><span style="color:#75715e"></span><span style="color:#a6e22e">object</span>(<span style="color:#a6e22e">Generator</span>)<span style="color:#75715e">#3 (0) {
</span><span style="color:#75715e"></span>}
</code></pre></div><blockquote>
<p><strong>yield</strong>: 迭代生成器, 也是一个函数; 不同的是这个函数的返回值是依次返回, 而不是只返回一个单独的值。或者换句话说, 生成器使你能更方便的实现了迭代器接口。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">Generator</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">Iterator</span> {
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">current</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">mixed</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">key</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">mixed</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">next</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">void</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">rewind</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">void</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">send</span> ( <span style="color:#a6e22e">mixed</span> $value ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">mixed</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">throw</span> ( <span style="color:#a6e22e">Exception</span> $exception ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">void</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">valid</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">bool</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">__wakeup</span> ( <span style="color:#a6e22e">void</span> ) <span style="color:#f92672">:</span> <span style="color:#a6e22e">void</span>
}
</code></pre></div><p><code>yield</code>返回一个迭代器，而这个迭代器实现了Iterator接口。调用迭代器的方法一次, 其中的代码运行一次。例如，如果你调用<code>$generator-&gt;rewind()</code>，那么<code>generator()</code>里的代码就会运行到控制流第一次出现<code>yield</code>的地方。而函数内传递给<code>yield</code>语句的返回值可以通过<code>$range-&gt;current()</code>获取.
为了继续执行生成器中<code>yield</code>后的代码，你就需要调用<code>$range-&gt;next()</code>方法。这将再次启动生成器，直到下一次<code>yield</code>语句出现。因此，连续调用<code>next()</code>和<code>current()</code>方法, 你就能从生成器里获得所有的值，直到再没有<code>yield</code>语句出现。对<code>generator()</code>来说，这种情形出现在<code>$from</code>超过<code>$to</code>时. 在这中情况下，控制流将到达函数的终点，因此将不执行任何代码。一旦这种情况发生, <code>vaild()</code>方法将返回假，这时迭代结束。</p>
<h2 id="认识协程">认识协程</h2>
<h3 id="进程">进程</h3>
<p>众所周知，PHP使用的是进程模型。所谓进程：</p>
<ul>
<li>从用户角度看：进程就是运行起来的程序，程序运行起来需要被加载到内存中；</li>
<li>从操作系统看：进程就是操作系统的描述，这个描述叫PCB（进程控制块）</li>
</ul>
<p>PHP中的进程扩展：<code>PCNTL</code>, 其使用方法前面的分享有讲过，也可以去研读<code>workerman</code>的源码，了解其应用。关于PHP的进程模型，可以看看我司何雄伟写的一篇博客：https://www.iddahe.com/jishu/9.html</p>
<h3 id="线程">线程</h3>
<p>因为fork一个新的进程，差不多要拷贝主线程的全部资源，所以新开一个进程的开销比较大。所以出现了线程。它是CPU可执行的一个单元。</p>
<p>PHP中针对线程的扩展：<code>pthreads</code> ，这个东西限制大，基本没谁用。</p>
<blockquote>
<p>网友总结，进程与线程的区别</p>
<p>进程=火车，线程=车厢</p>
<ul>
<li>线程在进程下行进（单纯的车厢无法运行）</li>
<li>一个进程可以包含多个线程（一辆火车可以有多个车厢）</li>
<li>不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘）</li>
<li>同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易）</li>
<li>进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源）</li>
<li>进程间不会相互影响，一个线程挂掉将导致整个进程挂掉（一列火车不会影响到另外一列火车，但是如果一列火车上中间的一节车厢着火了，将影响到所有车厢）</li>
<li>进程可以拓展到多机，进程最多适合多核（不同火车可以开在多个轨道上，同一火车的车厢不能在行进的不同的轨道上）</li>
<li>进程使用的内存地址可以上锁，即一个线程使用某些共享内存时，其他线程必须等它结束，才能使用这一块内存。（比如火车上的洗手间）－&ldquo;互斥锁&rdquo;</li>
<li>进程使用的内存地址可以限定使用量（比如火车上的餐厅，最多只允许多少人进入，如果满了需要在门口等，等有人出来了才能进去）－“信号量”</li>
</ul>
</blockquote>
<h3 id="协程">协程</h3>
<p>因为线程的执行需要CPU的调度，而且线程之间操作资源还需要锁，于是大家又打起了协程的主意。协程，又称微线程，纤程。英文名Coroutine。要了解协程的实现原理，可以看看Golang的GMP模型的实现：https://learnku.com/articles/41728</p>
<h2 id="使用生成器实现协程任务调度">使用生成器实现协程任务调度</h2>
<p><strong>yield能把数据发出来，那能把数据发给yield吗？</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">declare</span>(<span style="color:#a6e22e">strict_types</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">logger</span>($file)
{
    $handler <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($file, <span style="color:#e6db74">&#39;a+&#39;</span>);
    <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
        <span style="color:#a6e22e">fwrite</span>($handler, <span style="color:#66d9ef">yield</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">PHP_EOL</span>);
    }
}

$logger <span style="color:#f92672">=</span> <span style="color:#a6e22e">logger</span>(<span style="color:#66d9ef">__DIR__</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/demo.log&#39;</span>);

$logger<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;hello&#39;</span>);
$logger<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;你是yield吗？&#39;</span>);
</code></pre></div><p>这儿<code>yield</code>没有作为一个语句来使用, 而是用作一个表达式, 即它能被演化成一个值。这个值就是调用者传递给<code>send()</code>方法的值。在这个例子里, <code>yield</code>表达式将首先被&quot;hello&quot;替代写入文件, 然后被&quot;你是yield吗？&quot; 替代写入文件。</p>
<h3 id="迎来送往">迎来送往</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">pipe</span>()
{
    $result <span style="color:#f92672">=</span> (<span style="color:#66d9ef">yield</span> <span style="color:#e6db74">&#39;yield 1&#39;</span>); <span style="color:#75715e">// php7 之前必须加括号
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dump</span>($result);
    $result <span style="color:#f92672">=</span> (<span style="color:#66d9ef">yield</span> <span style="color:#e6db74">&#39;yield 2&#39;</span>);
    <span style="color:#a6e22e">dump</span>($result);
}

$pipe <span style="color:#f92672">=</span> <span style="color:#a6e22e">pipe</span>();

<span style="color:#a6e22e">dump</span>($pipe<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span>());

<span style="color:#a6e22e">dump</span>($pipe<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;result 1&#39;</span>));

<span style="color:#a6e22e">dump</span>($pipe<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#39;result 2&#39;</span>));
</code></pre></div><h3 id="先抽象一个任务">先抽象一个任务</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">declare</span>(<span style="color:#a6e22e">strict_types</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">Study</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Generator</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Task</span>
{
    <span style="color:#66d9ef">protected</span> $taskId;
    <span style="color:#66d9ef">protected</span> $coroutine;
    <span style="color:#66d9ef">protected</span> $sendValue <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
    <span style="color:#66d9ef">protected</span> $beforeFirstYield <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($taskId, <span style="color:#a6e22e">Generator</span> $coroutine)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskId</span> <span style="color:#f92672">=</span> $taskId;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">coroutine</span> <span style="color:#f92672">=</span> $coroutine;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getTaskId</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskId</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setSendValue</span>($sendValue)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sendValue</span> <span style="color:#f92672">=</span> $sendValue;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>()
    {
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beforeFirstYield</span>) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beforeFirstYield</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;

            <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">coroutine</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">current</span>();
        } <span style="color:#66d9ef">else</span> {
            $sent <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">coroutine</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">send</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sendValue</span>);
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">sendValue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;

            <span style="color:#66d9ef">return</span> $sent;
        }
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isFinished</span>()
    {
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">coroutine</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">valid</span>();
    }
}
</code></pre></div><h3 id="调度器实现">调度器实现</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">declare</span>(<span style="color:#a6e22e">strict_types</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">Study</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Generator</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">SplQueue</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Scheduler</span>
{
    <span style="color:#66d9ef">protected</span> $maxTaskId <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">protected</span> $taskMap <span style="color:#f92672">=</span> []; <span style="color:#75715e">// taskId =&gt; task
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> $taskQueue;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct()
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SplQueue</span>();
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addTask</span>(<span style="color:#a6e22e">Generator</span> $coroutine)
    {
        $taskId <span style="color:#f92672">=</span> <span style="color:#f92672">++</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">maxTaskId</span>;
        $task <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Task</span>($taskId, $coroutine);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskMap</span>[$taskId] <span style="color:#f92672">=</span> $task;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">schedule</span>($task);

        <span style="color:#66d9ef">return</span> $taskId;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">schedule</span>(<span style="color:#a6e22e">Task</span> $task)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskQueue</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">enqueue</span>($task);
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>()
    {
        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskQueue</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isEmpty</span>()) {
            <span style="color:#e6db74">/** @var Task $task */</span>
            $task <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">taskQueue</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">dequeue</span>();
            $value <span style="color:#f92672">=</span> $task<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();

            <span style="color:#66d9ef">if</span> ($value <span style="color:#a6e22e">instanceof</span> <span style="color:#a6e22e">SystemCall</span>) { <span style="color:#75715e">// 会直接把头三个Task对象拿出来
</span><span style="color:#75715e"></span>                $value($task, $this);
                <span style="color:#66d9ef">continue</span>;
            }

            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$task<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isFinished</span>()) {
                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">schedule</span>($task);
            }
        }
    }
}
</code></pre></div><h3 id="任务与调度器之间的通信">任务与调度器之间的通信</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">declare</span>(<span style="color:#a6e22e">strict_types</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">Study</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SystemCall</span>
{
    <span style="color:#66d9ef">protected</span> $callback;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct(<span style="color:#a6e22e">callable</span> $callback)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">callback</span> <span style="color:#f92672">=</span> $callback;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __invoke(<span style="color:#a6e22e">Task</span> $task, <span style="color:#a6e22e">Scheduler</span> $scheduler)
    {
        $callback <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">callback</span>;
        <span style="color:#66d9ef">return</span> $callback($task, $scheduler);
    }
}
</code></pre></div><h3 id="使用">使用</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">declare</span>(<span style="color:#a6e22e">strict_types</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Study\Scheduler</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Study\SystemCall</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Study\Task</span>;

<span style="color:#66d9ef">require</span> <span style="color:#66d9ef">__DIR__</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/vendor/autoload.php&#39;</span>;

$scheduler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Scheduler</span>();

$scheduler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addTask</span>(<span style="color:#a6e22e">task</span>(<span style="color:#ae81ff">5</span>));
$scheduler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addTask</span>(<span style="color:#a6e22e">task</span>(<span style="color:#ae81ff">10</span>));
$scheduler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addTask</span>(<span style="color:#a6e22e">task</span>(<span style="color:#ae81ff">100</span>));

$scheduler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">run</span>();

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">task</span>($max) {
    $taskId <span style="color:#f92672">=</span> (<span style="color:#66d9ef">yield</span> <span style="color:#a6e22e">getTaskId</span>());

    <span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; $i <span style="color:#f92672">&lt;=</span> $max; <span style="color:#f92672">++</span>$i) {
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;This is task </span><span style="color:#e6db74">{</span>$taskId<span style="color:#e6db74">}</span><span style="color:#e6db74"> iteration </span><span style="color:#e6db74">{</span>$i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">PHP_EOL</span>;
        <span style="color:#66d9ef">yield</span>;
    }
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getTaskId</span>() {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SystemCall</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">Task</span> $task, <span style="color:#a6e22e">Scheduler</span> $scheduler) {
        $task<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setSendValue</span>($task<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getTaskId</span>());
        $scheduler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">schedule</span>($task);
    });
}
</code></pre></div><h3 id="流程">流程</h3>
<p><img src="/images/generator-flow.jpg" alt="generator-flow"></p>
<h2 id="参考与说明">参考与说明</h2>
<p>本次分享的协程案例来源于一篇文章：http://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html</p>
<p>鸟哥翻译版：https://www.laruence.com/2015/05/28/3038.html</p>
<p>因为时间关系和自身水平原因，这篇文章有一个更为复杂的例子我没有分享。</p>
<blockquote>
<p><strong>使用生成器实现协程任务调度调度，可以在一定程度上解耦，提高代码的可维护性。至于它是否能真正提升性能，充分地利用CPU的多核，目前还没有验证，也没找到相关的资料。</strong></p>
</blockquote></div>
        <div class="post_footer">
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>△</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://zeuk.me">Designed by Zeuk,</a>
    <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
  </div>

  <div class="footer_slogan">
    <span>仗剑江湖载酒行</span>
  </div>
</footer>



<script src="http://xiaker.net/js/jquery-3.3.1.min.js"></script>
<script src="http://xiaker.net/js/zozo.js"></script>
<script src="http://xiaker.net/js/highlight.pack.js"></script>
<link  href="http://xiaker.net/css/fancybox.min.css" rel="stylesheet">
<script src="http://xiaker.net/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>


  <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>






</body>
</html>
